import swisseph as swe
import pandas as pd
from datetime import datetime, timedelta

swe.set_ephe_path(".")

PLANETS = {
    "सूर्य": swe.SUN,
    "मंगल": swe.MARS,
    "बुध": swe.MERCURY,
    "गुरु": swe.JUPITER,
    "शुक्र": swe.VENUS,
    "शनि": swe.SATURN,
    "राहु": swe.MEAN_NODE
}

def navamsha(deg):
    return int((deg % 30) / 3.333333) + 1

start_time = datetime.utcnow()
end_time = start_time + timedelta(days=30)

current = start_time

active = {}
results = []

while current <= end_time:
    jd = swe.julday(
        current.year,
        current.month,
        current.day,
        current.hour + current.minute / 60
    )

    moon_deg = swe.calc(jd, swe.MOON)[0][0]
    moon_nav = navamsha(moon_deg)

    matches = []

    for name, planet in PLANETS.items():
        planet_deg = swe.calc(jd, planet)[0][0]
        planet_nav = navamsha(planet_deg)

        if planet_nav == moon_nav:
            matches.append(name)

    key = "-".join(matches)

    if key and key not in active:
        active[key] = current

    ended = []

    for k in list(active.keys()):
        if k != key:
            results.append([
                f"चंद्र-{k}",
                active[k].strftime("%Y-%m-%d %H:%M"),
                current.strftime("%Y-%m-%d %H:%M")
            ])
            ended.append(k)

    for k in ended:
        del active[k]

    current += timedelta(hours=1)

for k, start in active.items():
    results.append([
        f"चंद्र-{k}",
        start.strftime("%Y-%m-%d %H:%M"),
        end_time.strftime("%Y-%m-%d %H:%M")
    ])

df = pd.DataFrame(
    results,
    columns=["संयोजन", "शुरू_समय", "समाप्त_समय"]
)

df.to_csv("conjunctions.csv", index=False)

print("Generated conjunctions.csv successfully")
